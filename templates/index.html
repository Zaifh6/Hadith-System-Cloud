<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if lang == 'en' %}Hadith Encyclopedia{% else %}جامع الأحاديث{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Add beautiful Arabic fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap">
    {% if lang == 'en' %}
    <style>
        body.ltr {
            direction: ltr;
            text-align: left;
            font-family: 'Merriweather', 'Georgia', serif;
            background: #f9f9f9;
            color: #222;
        }
        .header, .container, .tab-content, .hadith-title, .hadith-content, .narrator-link {
            text-align: left;
        }
        .header {
            background: #1a237e;
            color: #fff;
            border-bottom: 2px solid #3949ab;
        }
        .nav-link {
            color: #fff;
            font-weight: bold;
        }
        .nav-link.toggle {
            background: #fff;
            color: #1a237e;
            border-radius: 4px;
            padding: 4px 12px;
            margin-left: 10px;
            border: 1px solid #3949ab;
            transition: background 0.2s, color 0.2s;
        }
        .nav-link.toggle.active {
            background: #3949ab;
            color: #fff;
        }
        .hadith-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5em;
        }
        .hadith-content {
            font-size: 1.2rem;
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 1.5em;
        }
        .tab-content h3 {
            font-size: 1.3rem;
            color: #1a237e;
            border-bottom: 1px solid #3949ab;
            margin-bottom: 1em;
            padding-bottom: 0.3em;
        }
        .narrator-link {
            color: #3949ab;
            font-weight: 500;
            cursor: pointer;
        }
        .narrator-link:hover {
            text-decoration: underline;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    {% endif %}
    <style>
        /* Search bar styles */
        .search-container {
            margin-right: 20px;
        }
        
        .search-form {
            display: flex;
            align-items: center;
        }
        
        .search-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            direction: rtl;
            font-family: 'Tajawal', sans-serif;
        }
        
        .search-btn {
            padding: 8px 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .search-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body class="{% if lang == 'en' %}ltr{% else %}rtl{% endif %}">
    <!-- Modal for narrator details -->
    <div id="narratorModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-header">
                <div class="narrator-display">
                    <h2 id="narratorName">معلومات الراوي</h2>
                    <div id="narratorReliability" class="reliability-tag"></div>
                </div>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="info">شناسنامه و ترجمه</div>
                <div class="modal-tab" data-tab="jarh">جرح و تعديل</div>
                {% if lang == 'en' %}
                <div class="modal-tab" data-tab="evaluation">English Evaluation</div>
                {% endif %}
            </div>
            <div class="modal-body">
                <div id="infoTab" class="modal-tab-content active">
                    <!-- Info content will be populated here -->
                    <div class="narrator-info">
                        <div class="info-row">
                            <div class="info-label">الاسم :</div>
                            <div class="info-value" id="narratorFullName"></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">لقب :</div>
                            <div class="info-value" id="narratorTitle"></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">كنية :</div>
                            <div class="info-value" id="narratorKunya"></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">المذهب :</div>
                            <div class="info-value" id="narratorSect"></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">وفات :</div>
                            <div class="info-value" id="narratorDeath"></div>
                        </div>
                    </div>
                </div>
                <div id="jarhTab" class="modal-tab-content">
                    <!-- Jarh content will be populated here -->
                    <div class="narrator-jarh">
                        <div id="narratorEvaluations">
                            <!-- Evaluations will be populated here -->
                        </div>
                    </div>
                </div>
                {% if lang == 'en' %}
                <div id="evaluationTab" class="modal-tab-content">
                    <!-- English evaluation content will be populated here -->
                    <div class="narrator-evaluation-en">
                        <div id="narratorEvaluationsEn">
                            <!-- English evaluations will be populated here -->
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="header">
        <div class="nav-links">
            <a href="#" class="nav-link">بطاقة الكتاب</a>
            <a href="#" class="nav-link">فهرس الأحاديث</a>
        </div>
        <div class="search-container">
            <form action="{{ url_for('search_hadith', lang=lang) }}" method="get" class="search-form">
                <input type="text" name="hadith_id" placeholder="ادخل رقم الحديث للبحث...">
                <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <div style="margin-right: 20px;">
            <a href="{{ url_for(request.endpoint, hadith_id=hadith_id, lang='ar') if lang == 'en' and hadith_id is defined else url_for(request.endpoint, lang='ar') if lang == 'en' else url_for(request.endpoint, hadith_id=hadith_id, lang='en') if lang == 'ar' and hadith_id is defined else url_for(request.endpoint, lang='en') }}"
               class="nav-link toggle {% if lang == 'en' %}active{% endif %}">
                {% if lang == 'en' %}العربية{% else %}English{% endif %}
            </a>
        </div>
    </div>

    <div class="container">
        <!-- Reference tabs at the top -->
        <div class="reference-section">
            <div class="reference-heading">نفس الحديث في المصادر الأخرى:</div>
            <div class="reference-tabs">
                {% if reference_entries and reference_entries|length > 0 %}
                    {% for ref in reference_entries %}
                    <a href="{{ url_for('show_hadith', hadith_id=ref.hadithId) }}" class="reference-tab {% if ref.hadithId == hadith_id %}current-ref{% endif %}" title="المصدر: {{ ref.sourceMainTitle }}">
                        {{ ref.sourceMainTitle }} ج{{ ref.vol }} ص{{ ref.pageNum }}
                    </a>
                    {% endfor %}
                {% else %}
                    <span class="no-references">لا توجد مصادر أخرى لهذا الحديث</span>
                {% endif %}
            </div>
        </div>

        <div class="nav-tabs">
            <a href="#" class="nav-tab">الحديث اللاحق</a>
            <a href="#" class="nav-tab">الحديث السابق</a>
            <div style="flex-grow: 1;"></div>
            <div class="hadith-id">{{ hadith_id }}</div>
        </div>

        <div class="hadith-container">
            {% if hadith_title %}
            <div class="hadith-title">{{ hadith_title }}</div>
            {% else %}
            <div class="hadith-title">{{ book_title }} {{ volume }} ج {{ page_num }} ص</div>
            {% endif %}
            
            {% if hadith_chapter %}
            <div class="hadith-chapter">{{ hadith_chapter }}</div>
            {% endif %}
            
            <div class="hadith-narrator">
                <span>القائل :</span> {{ originated_from }}
            </div>
            
            <div class="hadith-content">
                {{ hadith_content }}
            </div>
            
            <div class="actions-bar">
                <button class="action-btn"><i class="fas fa-share-alt"></i></button>
                <button class="action-btn"><i class="fas fa-bookmark"></i></button>
                <button class="action-btn"><i class="fas fa-qrcode"></i></button>
        </div>

            <div class="divider"></div>
        </div>

        <div class="tabs-container">
            <div class="tab active">معلومات السند</div>
        </div>

        <div class="tab-content">
            <div id="sanad" class="tab-panel">
                <h3>سند الحديث:</h3>
                
                {% for path in sanad_entries %}
                <div class="sanad-full-path">
                    <div class="sanad-number">سند رقم {{ path.path_num }}</div>
                    <div class="sanad-content">
                        <!-- First show the original sanad text exactly as is -->
                        <p class="sanad-original-text">{{ path.sanad_description or path.formatted_chain }}</p>
                        
                        <!-- Then show the clickable narrator names -->
                        <div class="narrator-links-container">
                            {% for narrator in path.narrators %}
                            {% set special_name = None %}
                            {% for special_narrator, data in path.special_narrators.items() %}
                                {% if data.narrator_id == narrator.narrator_id %}
                                    {% set special_name = special_narrator %}
                                {% endif %}
                            {% endfor %}
                            <span class="narrator-link" data-narrator-id="{{ narrator.narrator_id }}">
                                {% if special_name %}{{ special_name }}{% else %}{{ narrator.narrator_name }}{% endif %}
                            </span>
                            {% if not loop.last %}<span class="narrator-separator"></span>{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="hadith-uuid">
                <small>Hadith UUID: {{ hadith_uuid }}</small>
            </div>
        </div>
    </div>

    <script>
        // Modal functionality
        const modal = document.getElementById("narratorModal");
        const closeModal = document.querySelector(".close-modal");
        const narratorName = document.getElementById("narratorName");
        const narratorFullName = document.getElementById("narratorFullName");
        const narratorTitle = document.getElementById("narratorTitle");
        const narratorKunya = document.getElementById("narratorKunya");
        const narratorSect = document.getElementById("narratorSect");
        const narratorDeath = document.getElementById("narratorDeath");
        const narratorEvaluations = document.getElementById("narratorEvaluations");
        const narratorEvaluationsEn = document.getElementById("narratorEvaluationsEn");
        
        // Tab functionality within modal
        const modalTabs = document.querySelectorAll(".modal-tab");
        const tabContents = document.querySelectorAll(".modal-tab-content");
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", function() {
            // No need to call processSanadDescriptions() anymore since we're generating clickable narrators on the server side
            // Just attach the click handlers
            attachNarratorLinkHandlers();
        });
        
        // Attach click handlers to narrator links
        function attachNarratorLinkHandlers() {
            const narratorLinks = document.querySelectorAll('.narrator-link');
            console.log(`Found ${narratorLinks.length} narrator links to attach handlers to`);
            
            narratorLinks.forEach((link, index) => {
                link.addEventListener('click', function(e) {
                    console.log(`Narrator link clicked: ${this.textContent}`);
                    e.preventDefault();
                    const narratorId = this.getAttribute('data-narrator-id');
                    console.log(`Fetching details for narrator ID: ${narratorId}`);
                    if (narratorId) {
                        fetchNarratorDetails(narratorId);
                    }
                });
            });
        }
        
        // Fetch narrator details from the API
        function fetchNarratorDetails(narratorId) {
            fetch(`/api/narrator/${narratorId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Narrator data received:', data); // Debug logging
                    
                    // Update modal with narrator details
                    narratorName.textContent = data.name || 'معلومات الراوي';
                    
                    // Set reliability if available
                    const reliabilityEl = document.getElementById('narratorReliability');
                    if (data.reliability) {
                        reliabilityEl.textContent = data.reliability;
                        reliabilityEl.style.display = 'block';
                    } else {
                        reliabilityEl.style.display = 'none';
                    }
                    
                    narratorFullName.textContent = data.name || '';
                    narratorTitle.textContent = data.titles || 'غير متوفر';
                    narratorKunya.textContent = data.patronymic || 'غير متوفر';
                    narratorSect.textContent = data.sect || 'غير متوفر';
                    
                    // Format death information - split by slash for separate lines
                    let deathInfo = 'غير متوفر';
                    if (data.death_records && data.death_records.length > 0) {
                        deathInfo = data.death_records.map(record => 
                            `${record.death_year} (${record.source})`
                        ).join('<br>');
                    }
                    narratorDeath.innerHTML = deathInfo;
                    
                    // Format evaluations - split sources by comma for separate lines
                    let evaluationsHtml = '';
                    if (data.evaluations && data.evaluations.length > 0) {
                        evaluationsHtml = data.evaluations.map(eval => {
                            // Split multiple sources by comma and format them on separate lines
                            const sourceLines = eval.source.split(',').map(s => s.trim()).join('<br>');
                            
                            return `<div class="jarh-item">
                                <div class="jarh-source">المصدر:<br>${sourceLines}</div>
                                <div class="jarh-text">${eval.evaluation}</div>
                                ${eval.summary ? `<div class="jarh-summary">ملخص: ${eval.summary}</div>` : ''}
                            </div>`;
                        }).join('');
                    } else {
                        evaluationsHtml = '<div class="jarh-item"><div class="jarh-text">لا يوجد تقييمات متوفرة</div></div>';
                    }
                    narratorEvaluations.innerHTML = evaluationsHtml;
                    
                    // Handle English evaluations if we're in English mode
                    if (narratorEvaluationsEn) {
                        let evaluationsEnHtml = '';
                        if (data.evaluations && data.evaluations.length > 0) {
                            evaluationsEnHtml = data.evaluations.map(eval => {
                                const sourceLines = eval.source.split(',').map(s => s.trim()).join('<br>');
                                
                                return `<div class="jarh-item">
                                    <div class="jarh-source">Source:<br>${sourceLines}</div>
                                    <div class="jarh-text">${eval.evaluation}</div>
                                    ${eval.summary ? `<div class="jarh-summary">Summary: ${eval.summary}</div>` : ''}
                                </div>`;
                            }).join('');
                        } else {
                            evaluationsEnHtml = '<div class="jarh-item"><div class="jarh-text">No evaluations available</div></div>';
                        }
                        narratorEvaluationsEn.innerHTML = evaluationsEnHtml;
                    }
                    
                    // Show modal
                    modal.style.display = "block";
                    document.body.style.overflow = "hidden"; // Prevent scrolling
                })
                .catch(error => {
                    console.error('Error fetching narrator details:', error);
                    alert('حدث خطأ أثناء جلب معلومات الراوي');
                });
        }
        
        // Close modal when clicking the X
        closeModal.addEventListener("click", function() {
            modal.style.display = "none";
            document.body.style.overflow = "auto"; // Enable scrolling
        });
        
        // Close modal when clicking outside
        window.addEventListener("click", function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                document.body.style.overflow = "auto"; // Enable scrolling
            }
        });
        
        // Modal tab switching
        modalTabs.forEach(tab => {
            tab.addEventListener("click", function() {
                // Remove active class from all tabs and contents
                modalTabs.forEach(t => t.classList.remove("active"));
                tabContents.forEach(c => c.classList.remove("active"));
                
                // Add active class to selected tab
                this.classList.add("active");
                
                // Show corresponding content
                const tabId = this.getAttribute("data-tab") + "Tab";
                document.getElementById(tabId).classList.add("active");
            });
        });
    </script>
</body>
</html>
